<!doctype html>
<html xmlns:ng="http://angularjs.org" ng-app="synapseClient">
<head>
    <title>Synapse</title>
    <style type="text/css">
        label {
            float: left;
            width: 5em;
            text-align: right;
            margin-right: 1em;
        }

        .message {
            clear: both;
        }

        .message .sender {
            float: left;
            width: 22em;
            text-align: right;
            margin-right: 1em;
        }
        
        .message .body {
            margin-left: 22em;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.20/angular.min.js"></script>
</head>
<body>

    <div ng-controller="LoginController" ng-hide="hideLogin" class="login">
        <h3>Login:</h3>
        <form novalidate>
            <label for="user_id">User:</label>
            <input id="user_id" size="50" type="text" auto-focus ng-model="account.user_id" /><br />
            <label for="server">Server:</label>
            <input id="server" size="50" type="text" ng-model="account.server" /><br />
            <label for="room">Room:</label>
            <input id="room" size="50" type="text" ng-model="room" /><br />
            <button ng-click="login()">Login</button>
        </form>
        <br/>
        {{ feedback }}
    </div>

    <div ng-controller="ChatController" ng-hide="hideChat" class="chat">
        <h3>{{ state.room }}</h3>
        
        <div class="message" ng-repeat="msg in messages">
            <!-- XXX: need timestamp support!!! -->
            <div class="sender">&lt;{{msg.user_id}}&gt;</div>
            <div class="body">{{msg.content.body}}</div>
        </div>
        
        {{ state.user_id }} <input id="textInput" size="132" ng-model="textInput" ng-enter="send()" />
        <button ng-click="send()">Send</button>
        <br/>
        {{ feedback }}
    </div>
        
    <script>
      
    angular.module('synapseClient', [])
        .factory('state', function () {
            'use strict';
            var state = {};
            return {
                "state": state,
            };
        })
        .controller('LoginController', ['$scope', '$rootScope', '$http', '$timeout', 'state',
                                        function($scope, $rootScope, $http, $timeout, state) {
            'use strict';
            $scope.state = state.state;
            $scope.account = {
                "server": "http://matrix.openmarket.com",
            }
            $scope.room = "tng";
            
            $scope.login = function() {
                var data = {
                  "user_id" : $scope.account.user_id
                };
                $http.post($scope.account.server + "/register", data).
                    success(function(data, status, headers, config) {
                        $scope.feedback = "Success";
                        $scope.state.server = $scope.account.server;
                        $scope.state.access_token = data.access_token;
                        $scope.state.user_id = data.user_id;
                        $scope.state.room = $scope.room;
                        $scope.hideLogin = true;
                        $rootScope.$broadcast('loginEvent'); // XXX: how come emit doesn't work here?
                    }).
                    error(function(data, status, headers, config) {
                        $scope.feedback = "Failure: " + data;
                    });
            };
        }])
        .directive('ngEnter', function () {
            return function (scope, element, attrs) {
                element.bind("keydown keypress", function (event) {
                    if(event.which === 13) {
                        scope.$apply(function () {
                            scope.$eval(attrs.ngEnter);
                        });
                        event.preventDefault();
                    }
                });
            };
        })
        .directive('autoFocus', ['$timeout', function($timeout) {
            return {
                link: function(scope, element, attr) {
                    $timeout(function() { element[0].focus() }, 0);
                }
            }
        }])
        .controller('ChatController', ['$scope', '$log', '$q', '$http', '$timeout', 'state',
                                       function($scope, $log, $q, $http, $timeout, state) {
           'use strict';
            $scope.state = state.state;
            $scope.hideChat = true;
            $scope.messages = [];
            $scope.state.events_from = "START";
            
            var shortPoll = function() {
                $http.get($scope.state.server + "/events", {
                    "params": {
                        "access_token" : $scope.state.access_token,
                        "from" : $scope.state.events_from,
                        "timeout" : 25,
                    }})
                    .then(function(response) {
                        $scope.feedback = "Success";

                        $scope.state.events_from = response.data.end;

                        for (var i = 0; i < response.data.chunk.length; i++) {
                            var chunk = response.data.chunk[i];
                            if (chunk.room_id == $scope.state.room && chunk.type == "sy.room.message") {
                                $scope.messages.push(chunk);
                            }
                        }
                        
                        $timeout(shortPoll, 0);
                    }, function(response) {
                        $scope.feedback = "Can't stream: " + response.data;
                        $timeout(shortPoll, 1000);
                    });
            };
            
            $scope.send = function() {
                if ($scope.textInput == "") {
                    return;
                }
                var msg_id = "m" + new Date().getTime();
                $http.put($scope.state.server + "/rooms/" + $scope.state.room + "/messages/" + $scope.state.user_id + "/" + msg_id, {
                        "body": $scope.textInput,
                        "msgtype": "sy.text",
                    }, {
                        "params" : {
                            "access_token" : $scope.state.access_token
                        }
                    })
                    .success(function(data, status, headers, config) {
                        $scope.feedback = "Sent successfully";
                        $scope.textInput = "";
                    })
                    .error(function(data, status, headers, config) {
                        $scope.feedback = "Failed to send: " + response.data;
                    });                
            };
                        
            $scope.$on('loginEvent', function() {
                $scope.hideChat = false;
                $timeout(function() { document.getElementById('textInput').focus() }, 0);

                $http.put($scope.state.server + "/rooms/" + $scope.state.room + "/members/" + $scope.state.user_id + "/state", {
                        "membership": "join"
                    }, {
                        "params" : {
                            "access_token" : $scope.state.access_token
                        }
                    })
                    .success(function(data, status, headers, config) {
                        $timeout(shortPoll, 0);
                    })
                    .error(function(data, status, headers, config) {
                        $scope.feedback = "Can't join room: " + response.data;
                        return $q.reject(response.data);
                    });
            }); 
        }]);
    </script>
    
</body>
</html>
