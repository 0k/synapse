<!doctype html>
<html xmlns:ng="http://angularjs.org" ng-app="synapseClient">
<head>
    <title>Synapse</title>
    <script src="js/angular.js"></script>
</head>
<body>

    <div ng-controller="LoginController" ng-hide="hideLogin" class="login">
        <h3>Login:</h3>
        <form novalidate>
            User: <input type="text" ng-model="account.user_id" /><br />
            Server: <input type="text" ng-model="account.server" /><br />
            Room: <input type="text" ng-model="room" /><br />
            <button ng-click="login(user)">Login</button>
        </form>
        <br/>
        {{ feedback }}
    </div>

    <div ng-controller="ChatController" ng-hide="hideChat" class="chat">
        <h3>Chat</h3>
        
        <div class="message" ng-repeat="msg in messages">
            <!-- XXX: need timestamp support!!! -->
            <div class="sender">{{msg.user_id}}</div>
            <div class="body">{{msg.content.body}}</div>
        </div>
        
        <input size="80" ng-model="input" />
        <br/>
        {{ feedback }}
    </div>
        
    <script>
      
    angular.module('synapseClient', [])
        .factory('state', function () {
            'use strict';
            var state = {};
            return {
                "state": state,
            };
        })
        .controller('LoginController', ['$scope', '$rootScope', '$http', '$timeout', 'state',
                                        function($scope, $rootScope, $http, $timeout, state) {
            $scope.state = state.state;
            $scope.account = {
                "server": "http://localhost:8080"
            }
            $scope.room = "tng";
            
            $scope.login = function(user) {
                data = {
                  "user_id" : $scope.account.user_id
                };
                $http.post($scope.account.server + "/register", data).
                    success(function(data, status, headers, config) {
                        $scope.feedback = "Success";
                        $scope.state.server = $scope.account.server;
                        $scope.state.access_token = data.access_token;
                        $scope.state.user_id = data.user_id;
                        $scope.state.room = $scope.room;
                        $scope.hideLogin = true;
                        $rootScope.$broadcast('loginEvent'); // XXX: how come emit doesn't work here?
                    }).
                    error(function(data, status, headers, config) {
                        $scope.feedback = "Failure: " + data;
                    });
            };
        }])
        .controller('ChatController', ['$scope', '$log', '$q', '$http', '$timeout', 'state',
                                       function($scope, $log, $q, $http, $timeout, state) {
            $scope.state = state.state;
            $scope.hideChat = true;
            $scope.messages = [];
            
            $scope.$on('loginEvent', function() {
                $scope.hideChat = false;

                $http.put($scope.state.server + "/rooms/" + $scope.state.room + "/members/" + $scope.state.user_id + "/state", {
                        "membership": "join"
                    }, {
                        "params" : {
                            "access_token" : $scope.state.access_token
                        }
                    }).
                    then(function(response) {
                        // success
                        return $http.get($scope.state.server + "/events", {
                            "params": {
                                "access_token" : $scope.state.access_token,
                                "from" : "START"
                            }})
                    }, function(response) {
                        // failure
                        $scope.feedback = "Can't join room: " + response.data;
                        return $q.reject(response.data);
                    }).
                    then(function(response) {
                        $scope.feedback = "Success";
                        
                        $scope.state.start = response.data.start;
                        $scope.state.end = response.data.end;
                        
                        for (var i = 0; i < response.data.chunk.length; i++) {
                            var chunk = response.data.chunk[i];
                            if (chunk.room_id == $scope.state.room && chunk.type == "sy.room.message") {
                                $scope.messages.push(chunk);
                            }
                        }
                    }, function(response) {
                        $scope.feedback = "Can't stream: " + response.data;
                        return $q.reject(response.data);
                    });
            }); 
        }]);
    </script>
    
</body>
</html>